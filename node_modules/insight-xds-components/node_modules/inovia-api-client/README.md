# inovia-js-api-client

compatible to Insight 5.1-GA

This project contains reusable plain ES6 Promise based api client for Inovia products.

They are ordered by productName/service/endpoint

example to get rtc query service:

```javascript
import { rawQuery } from "insight-js-api-client/insight/rtc/query";
```

The corresponding endpoint url would be:
http://localhost:7776/rtc-service/query/raw

This package requires environment variables to be set. They are service related and are optional. Optional in that case means that they are only required if an endpoint is queried.

The endpoint configuration is required to have a tailing /, meaning: http://localhost:7776/rtc-service is invalid where as http://localhost:7776/rtc-service/ is valid.

An example on how to define those variables during build with webpack:
```javascript
plugins: [
    new webpack.DefinePlugin({
        "X_SERVICE_URL": JSON.stringify("http://my.ci.environment.de/x-service/"),
        "Y_SERVICE_URL": JSON.stringify("http://my.ci.environment.de/y-service/")
        ...
    })
]
```

As an alternative you can leverage configure function imported directly from the package :
```javascript
    import { configure } from "inovia-api-client";
```
afterwards you can configure the endpoints with something like this:
```javascript
    httpClient.get(URL)
     .then(env => configure(env))
 ```
 The url should return a json file with the same keys. If this is not used it falls back to the global variables.


All endpoints in general use the following status codes:
200 OK, 204 NoContent, 400 BadRequest (together with some information), 401 Unauthorized (session invalid), 403 Forbidden, 404 NotFound, 409 Conflict, 500 InternalServerError

If a token is set using the tokenService all requests are signed using that token.

The config parameter to all services is optional.

### http client
* `get(url: STRING, config: OBJECT)`:
  get a resource

* `post(url: STRING, payload: OBJECT, config: OBJECT)`:
  post some data to the server

* `put(url: STRING, payload: OBJECT, config: OBJECT)`:
  put some data to the server

* `_delete(url: STRING, payload: OBJECT, config: OBJECT)`:
  delete some data

* `upload(url: STRING, file: FILE, fileName: STRING (optional), formFileFieldName = "file": STRING (optional), fields: OBJECT (key value pairs), progressCallback: FUNCTION (optional), config: OBJECT)`:
  upload a file to the server using multipart/form-data

config example:
```javascript
{
    responseType: "text",
    impersonate: { by: "XILA": with: "some value"}
}
```

config default:
```javascript
{
    responseType: "json",
    method: "GET",
    headers: {
        "Accept": "application/json",
        "Content-Type": "application/json"
    }
}
```

The method is set correctly by the corresponding functions in http client.

### token service
* `setToken(token: STRING)`:
  add a token to the sessionStorage

* `removeToken()`:
    removes token from sessionStorage

* `getToken()`:
    get the token from the sessionStorage

A token is usually acquired from the server by using the systems login endpoint.

## Insight

required endpoint configuration: `RTC_DISPATCHER_URL`, `RTC_SERVICE_URL`, `APP_SERVICE_URL`, `ARCHIVE_SERVICE_URL`, `RAWDATA_DISPATCHER_URL`

### endpoint: dashboard (insight/app/dashboard):
* `listDashboards(config: OBJECT)`:
  returns a list of all dashboards (by id and name) the logged in, or impersonated user can see.

* `getDashboard(id: STRING, config: OBJECT)`:
  returns the configuration of a single dashboard

* `deleteDashboard(id: STRING, config: OBJECT)`:
  deletes a dashboard by id

* `updateDashboard(dashboard: OBJECT, config: OBJECT)`:
  update a dashboard (id required), widgets need to be present and each widget needs to have a configuration

* `createDashboard(dashboard: OBJECT, config: OBJECT)`:
  create a dashboard (id cannot be given), widgets need to be present and each widget needs to have a configuration

dashboard example config:
```javascript
{
    "layout": {
        "lg": [{
            "i": "0",
            "h": 2,
            "w": 4,
            "y": 0,
            "x": 0
        }, {
            "i": "1",
            "h": 2,
            "w": 8,
            "x": 5,
            "y": 0
        }, {
            "i": "2",
            "h": 2,
            "w": 4,
            "x": 0,
            "y": 1
        }, {
            "i": "3",
            "h": 2,
            "w": 8,
            "x": 5,
            "y": 1
        }, {
            "i": "4",
            "h": 2,
            "w": 12,
            "x": 0,
            "y": 2
        }],
        "md": [{
            "x": 0,
            "y": 0,
            "w": 3,
            "h": 2,
            "i": "0"
        }, {
            "i": "1",
            "h": 2,
            "w": 5,
            "x": 0,
            "y": 4
        }, {
            "i": "2",
            "h": 2,
            "w": 3,
            "x": 1,
            "y": 0
        }, {
            "i": "3",
            "h": 2,
            "w": 5,
            "x": 1,
            "y": 4
        }, {
            "i": "4",
            "h": 2,
            "w": 8,
            "x": 2,
            "y": 0
        }],
        "sm": [{
            "x": 0,
            "y": 0,
            "w": 2,
            "h": 2,
            "i": "0"
        }, {
            "i": "1",
            "h": 2,
            "w": 4,
            "x": 0,
            "y": 3
        }, {
            "i": "2",
            "h": 2,
            "w": 2,
            "x": 1,
            "y": 0
        }, {
            "i": "3",
            "h": 2,
            "w": 4,
            "x": 1,
            "y": 3
        }, {
            "i": "4",
            "h": 2,
            "w": 6,
            "x": 2,
            "y": 0
        }]
    },
    "widgets": [{
        "type": "nu.inovia.insight.record-counter",
        "setting": {
            "name": "File Count",
            "storeName": storeName
        },
        "receivedSignal": {},
        "groups": []
    }, {
        "type": "nu.inovia.insight.filesize-calculator",
        "setting": {
            "name": "Store Size",
            "storeName": storeName
        },
        "receivedSignal": {},
        "groups": []
    }, {
        "type": "nu.inovia.insight.base.pivot.pie.single",
        "setting": {
            "dataRetriever": {
                "jsonQuery": {
                    "groupBy": [{
                        "field": "senderUserName"
                    }],
                    "queries": [{
                        "name": "F1",
                        "formula": "CNT{[_time]}",
                        "datastore": storeName
                    }]
                },
                "pivotConfig": {
                    "groupByXCount": 1
                }
            },
            "echarts": {
                "title": {
                    "show": true,
                    "text": "Users",
                    "subtext": "",
                    "x": "center"
                },
                "legend": {
                    "show": true,
                    "top": "10px",
                    "orient": "vertical",
                    "x": "left"
                }
            }
        },
        "receivedSignal": {},
        "groups": []
    }, {
        "type": "nu.inovia.insight.react.echarts.pivot.scatter.line.bar",
        "setting": {
            "dataRetriever": {
                "jsonQuery": {
                    "groupBy": [{
                        "field": "_time",
                        "interval": "1day"
                    }],
                    "queries": [{
                        "name": "F1",
                        "formula": "CNT{[_time]}",
                        "datastore": storeName
                    }]
                },
                "pivotConfig": {
                    "groupByXCount": 1
                }
            },
            "echarts": {
                "title": {
                    "show": true,
                    "text": "Uploads over time",
                    "subtext": "",
                    "x": "center"
                },
                "legend": {
                    "show": true,
                    "top": "30px",
                    "x": "center"
                },
                "series": [{
                    "type": "line",
                    "name": "F1"
                }]
            }
        },
        "receivedSignal": {},
        "groups": []
    }, {
        "type": "nu.inovia.insight.rds.table",
        "setting": {
            "dataRetriever": {
                "jsonQuery": {
                    "page": 1,
                    "pageSize": 20,
                    "sortDescriptions": [{
                        "field": "_time",
                        "sortOrder": "DESC"
                    }],
                    "store": storeName,
                    "timeZone": timeZone
                }
            }
        },
        "receivedSignal": {},
        "groups": []
    }],
    "isPublic": false,
    "name": "archive-data-store-statistics",
    "tags": []
}
```

### endpoint: favorite (insight/app/favorite):
* `add(favorite: OBJECT, config: OBJECT)`:
  create a new favorite

* `remove(id: STRING, config: OBJECT)`:
  remove a favorite

favorite example:
```javascript
{
    type: STRING, // one of: "DASHBOARD", "QUERY", "DATASTORE", "ADATASTORE", "REPORT"
    identifier: STRING,
    name: STRING // optional
}
```

### endpoint: search (insight/app/search):
* `search(search: OBJECT, config: OBJECT)`:
  search for resources

config example:
```javascript
{
    includeDataStores: BOOLEAN,
    includeDashboards: BOOLEAN,
    includeQueries: BOOLEAN,
    includeReports: BOOLEAN,
    text: STRING
}
```

### endpoint: share (insight/app/share):
* `setSharePermission(share: OBJECT, config: OBJECT)`:
  create share for an resource, id may not be present

* `updateSharePermission(share: OBJECT, config: OBJECT)`:
  update share for a resource, id must be present

* `removeSharePermission(id: STRING)`:
  remove share for a resource

config example:
```javascript
{
    identifier: STRING,
    shareByLinkAccessType: STRING, // one of "NONE", "READ", "WRITE"
    users:[{
        shareAccessType: STRING, // one of "NONE", "READ", "WRITE"
        userName: STRING
    }]
}
```

### endpoint: user (insight/app/user):
* `login(creds: OBJECT, config: OBJECT)`:
  create a session (by default contains userName and password)

* `logout(config: OBJECT)`:
  invalidates a session

* `whoAmI(config: OBJECT)`:
  get info about the current user

### endpoint: user (insight/app/stagedStore):
* `getStagedStore(storeName: STRING, config: OBJECT)`:
  get info about a staged store

* `updateStagedStore(lcmData: OBJECT, config: OBJECT)`:
  update a staged store

* `acceptStagedStore(storeId: STRING, owner: STRING, config: OBJECT)`:
  accept a staged store

* `isStagedStore(storeName: STRING, config: OBJECT)`:
  check if `storeName` is a staged store

### endpoint: archive (insight/archive/archive):
* `listRoot(storeName: STRING, config: OBJECT)`:
  list the root of the ADS

* `listFolder(storeName: STRING, path: STRING, config: OBJECT)`:
  lists the content of a folder given its absolute path, where / is the root

* `create({ name: STRING, owner: STRING }, config: OBJECT)`:
  create a new default data store

* `deleteStore(storeType: STRING, storeName: STRING, config: OBJECT)`:
  delete a store

* `deleteFile(storeName: STRING, fileId: STRING, config: OBJECT)`:
  delete a single file

* `preview(storeName: STRING, fileId: STRING, page = 0: INT, numChars = 1000: INT, config: OBJECT)`:
  get stringified file content

* `generateDownloadLink(storeName: STRING, fileId: STRING)`:
  get the link to download a file

* `search(storeName: STRING, queryString: STRING, config: OBJECT)`:
  search the metadata

### endpoint: rtc store (insight/rtc/store):
* `create(dataStore: OBJECT, config: OBJECT)`:
  create a new default data store

* `deleteStore(storeName: STRING, config: OBJECT)`:
  delete a store

* `refresh(storeName: STRING, config: OBJECT)`:
  refresh a store mapping

* `finalize(storeName: STRING, config: OBJECT)`:
  finalize a store

* `count(storeName: STRING, config: OBJECT)`:
  count documents in a store

* `getLifeCyclePolicy(storeName: STRING, config: OBJECT)`:
  get lifecycle policy for a store

* `updateLifeCyclePolicy(lcmData: OBJECT, config: OBJECT)`:
  update the lifecycle policy of a store

### endpoint: postFile (insight/rawdata-dispatcher/data):
* `postFile(file: FILE, fileName: STRING, data: OBJECT (key value), processCallback: FUNCTION, config: OBJECT)`:
  send a file to the server

### endpoint: progress (insight/rawdata-dispatcher/progress):
* `getProgress(executionId: STRING, config: OBJECT)`:
  get the progress of post processing

### endpoint: doc (insight/rtc-dispatcher/doc):
* `createDocuments(storeName: STRING, documents: [{ key: "value" }], config: OBJECT)`:
 sends collection of documents for instertion, the storeName will be enrighed to all documents as field store

* `createDocument(storeName: STRING, documents: { key: "value" }, config: OBJECT)`:
  sends s document for instertion, the storeName will be enrighed to the document as field store

## IOT

required endpoint configuration: `IOT_SERVICE_URL`
