"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function buildDynamicDateVal(e,t){return t.startsWith("C")?"C"+e+t.substring(1):e+t}function parseValueToDynamic(e){var t="",r="";if(e){var a=new Date(e);if(isNaN(a.getTime()))try{var i=/\d+/;t=e.match(i)[0],r=e.substring(e.indexOf(t)+t.length),e.startsWith("C")&&(r="C"+r)}catch(n){t="",r=e}}return{numInitVal:t,unitInitVal:r}}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),_react=require("react"),_react2=_interopRequireDefault(_react),_classnames=require("classnames"),_classnames2=_interopRequireDefault(_classnames),_insightSharedComponents=require("insight-shared-components"),_IconButton=require("material-ui/IconButton"),_IconButton2=_interopRequireDefault(_IconButton),_removeCircleOutline=require("material-ui/svg-icons/content/remove-circle-outline"),_removeCircleOutline2=_interopRequireDefault(_removeCircleOutline),_Toggle=require("material-ui/Toggle"),_Toggle2=_interopRequireDefault(_Toggle),_momentTimezone=require("moment-timezone"),_momentTimezone2=_interopRequireDefault(_momentTimezone),_Card=require("material-ui/Card"),_Card2=_interopRequireDefault(_Card),_CardHeader=require("material-ui/Card/CardHeader"),_CardHeader2=_interopRequireDefault(_CardHeader),_CardText=require("material-ui/Card/CardText"),_CardText2=_interopRequireDefault(_CardText),_constants=require("../../constants"),XdsFilterExpression=function(e){function t(){var e;_classCallCheck(this,t);for(var r=arguments.length,a=Array(r),i=0;r>i;i++)a[i]=arguments[i];var n=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(a)));return n._changeFilterValue=n._changeFilterValue.bind(n),n._getFieldTypeByName=n._getFieldTypeByName.bind(n),n._getOperatorsOptionsByType=n._getOperatorsOptionsByType.bind(n),n._removeMe=n._removeMe.bind(n),n._changeDynamicDateNum=n._changeDynamicDateNum.bind(n),n._toggleDynamicDate=n._toggleDynamicDate.bind(n),n._changeFieldSelector=n._changeFieldSelector.bind(n),n}return _inherits(t,e),_createClass(t,[{key:"_getOperatorsOptionsByType",value:function(e){var t=this.props.operators;switch(e){case"string":return t.string;case"date":return t.date;case"boolean":return t.bool;case"double":return t.number;case"integer":return t.number;case"float":return t.number;case"long":return t.number;case"ip":return t.string;default:return t.dynamicDate}}},{key:"_getOperatorsOptions",value:function(e){if(!e)return[];var t=this._getFieldTypeByName(e);return this._getOperatorsOptionsByType(t)}},{key:"_getFieldTypeByName",value:function(e){var t=this.props.mappings.find(function(t){return t.name===e});return t?t.type:"string"}},{key:"_removeMe",value:function(){this.props.removeChildFilter(this.props.index)}},{key:"_changeFilterValue",value:function(e){this.props.updateChildFilter(this.props.index,Object.assign({},this.props.filter,{value:e.target.value}))}},{key:"_changeDynamicDateNum",value:function(e){var t=parseValueToDynamic(this.props.filter.value),r=t.unitInitVal,a=e.target.value,i=buildDynamicDateVal(a,r);this.props.updateChildFilter(this.props.index,Object.assign({},this.props.filter,{value:i}))}},{key:"_toggleDynamicDate",value:function(e){e.target.checked?this.props.updateChildFilter(this.props.index,Object.assign({},this.props.filter,{value:"1day"})):this.props.updateChildFilter(this.props.index,Object.assign({},this.props.filter,{value:_momentTimezone2["default"].tz(_momentTimezone2["default"]().format(),this.props.timeZone)}))}},{key:"_changeFieldSelector",value:function(e){var t=this,r=t._getFieldTypeByName(e),a=Object.assign({},t.props.filter,{field:e,operator:t._getOperatorsOptionsByType.bind(t)(r)[0].value});if(a.field)switch(r){case"date":a.value=_momentTimezone2["default"].tz(_momentTimezone2["default"]().format(),t.props.timeZone).format();break;case"boolean":a.value="true"}else a.value="",a.operator="";t.props.updateChildFilter(t.props.index,a)}},{key:"render",value:function(){var e=this.context.muiTheme,t=this.props.filter.value,r=this._getFieldTypeByName(this.props.filter.field),a=parseValueToDynamic(this.props.filter.value),i=this.props.filter.operator,n="MISSING"===i||"NOTMISSING"===i,s=a.numInitVal,l=a.unitInitVal,o=_momentTimezone2["default"](t),u=!o.isValid()&&""!==t,p=this,c=this.props.mappings.map(function(e){return e.name});return _react2["default"].createElement("div",{className:"custom-filter-expression flex-container flex-gutters-less"},_react2["default"].createElement(_insightSharedComponents.ValidatableDropDownList,{ref:"fieldSelect",isRequired:!0,value:this.props.filter.field||"",items:c,onChange:this._changeFieldSelector}),_react2["default"].createElement(_insightSharedComponents.ValidatableDropDownList,{ref:"operatorSelect",isRequired:!0,value:p.props.filter.operator,items:p._getOperatorsOptions.bind(p)(p.props.filter.field),onChange:function(e){return p.props.updateChildFilter(p.props.index,Object.assign({},p.props.filter,{operator:e}))}}),_react2["default"].createElement("div",{className:_classnames2["default"]("value-selector",{hidden:n||"date"===r||"boolean"===r})},_react2["default"].createElement(_insightSharedComponents.ValidatableTextField,{isRequired:!0,name:"val",value:this.props.filter.value||"",onChange:this._changeFilterValue})),"date"===r&&_react2["default"].createElement("div",{className:_classnames2["default"]("value-selector",{hidden:"date"!==r||n})},u?_react2["default"].createElement("div",{className:"flex-container"},_react2["default"].createElement(_insightSharedComponents.ValidatableTextField,{isRequired:!0,name:"numVal",value:s,onChange:this._changeDynamicDateNum}),_react2["default"].createElement(_insightSharedComponents.ValidatableDropDownList,{ref:"dynamicDateUnit",value:l,items:this.props.operators.dynamicDate,onChange:function(e){var t=buildDynamicDateVal(s,e);t&&p.props.updateChildFilter(p.props.index,Object.assign({},p.props.filter,{value:t}))}}),_react2["default"].createElement(_Toggle2["default"],{style:{width:150,paddingTop:12},label:"Dynamic Date",labelPosition:"right",defaultToggled:u,onClick:this._toggleDynamicDate})):_react2["default"].createElement("div",{className:_classnames2["default"]("filter-value flex-container",{hidden:u})},_react2["default"].createElement(_insightSharedComponents.DateTimePicker,{fontSize:"inherit",ref:"dateValueSelector",className:"filter-value",value:p.props.filter.value,onChange:function(e){return p.props.updateChildFilter(p.props.index,Object.assign({},p.props.filter,{value:e}))}}),_react2["default"].createElement(_Toggle2["default"],{style:{width:150,paddingTop:12},label:"Dynamic Date",labelPosition:"right",defaultToggled:u,onClick:this._toggleDynamicDate}))),_react2["default"].createElement("div",{className:_classnames2["default"]("value-selector",{hidden:"boolean"!==r||n})},_react2["default"].createElement(_insightSharedComponents.ValidatableDropDownList,{ref:"booleanValueSelector",value:p.props.filter.value,items:["true","false"],onChange:function(e){p.props.updateChildFilter(p.props.index,Object.assign({},p.props.filter,{value:e}))}})),_react2["default"].createElement(_IconButton2["default"],{style:{marginLeft:"auto",alignSelf:"center"},color:e.palette.accent2Color,onTouchTap:this._removeMe},_react2["default"].createElement(_removeCircleOutline2["default"],null)))}}]),t}(_react2["default"].Component);XdsFilterExpression.defaultProps={timeZone:_momentTimezone2["default"].tz.guess(),operators:{string:_constants.FILTER_DEFAULT_STRING_OPERATORS,number:_constants.FILTER_DEFAULT_NUMBER_OPERATORS,date:_constants.FILTER_DEFAULT_DATE_OPERATORS,bool:_constants.FILTER_DEFAULT_BOOLEAN_OPERATORS,dynamicDate:_constants.FILTER_DEFAULT_DYNAMIC_DATE_OPERATORS}},XdsFilterExpression.propTypes={filter:_react2["default"].PropTypes.object.isRequired,mappings:_react2["default"].PropTypes.arrayOf(_react2["default"].PropTypes.shape({name:_react2["default"].PropTypes.string.isRequired,type:_react2["default"].PropTypes.string.isRequired})),index:_react2["default"].PropTypes.number.isRequired,removeChildFilter:_react2["default"].PropTypes.func.isRequired,updateChildFilter:_react2["default"].PropTypes.func.isRequired,timeZone:_react2["default"].PropTypes.string.isRequired,operators:_react2["default"].PropTypes.shape({string:_react2["default"].PropTypes.arrayOf(_react2["default"].PropTypes.shape({value:_react2["default"].PropTypes.string.isRequired,text:_react2["default"].PropTypes.string.isRequired})),number:_react2["default"].PropTypes.arrayOf(_react2["default"].PropTypes.shape({value:_react2["default"].PropTypes.string.isRequired,text:_react2["default"].PropTypes.string.isRequired})),date:_react2["default"].PropTypes.arrayOf(_react2["default"].PropTypes.shape({value:_react2["default"].PropTypes.string.isRequired,text:_react2["default"].PropTypes.string.isRequired})),bool:_react2["default"].PropTypes.arrayOf(_react2["default"].PropTypes.shape({value:_react2["default"].PropTypes.string.isRequired,text:_react2["default"].PropTypes.string.isRequired})),dynamicDate:_react2["default"].PropTypes.arrayOf(_react2["default"].PropTypes.shape({value:_react2["default"].PropTypes.string.isRequired,text:_react2["default"].PropTypes.string.isRequired}))}).isRequired},XdsFilterExpression.contextTypes={muiTheme:_react2["default"].PropTypes.object.isRequired},exports["default"]=XdsFilterExpression;