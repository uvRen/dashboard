"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function buildChartOptions(e,t,i,r){var n=!!(t&&i.values&&t.queries),a={};return n?(a=_echarts4["default"](e,t,i),r&&(a=findSelectionFromSentSignal(r,a)),a):void 0}function findSelectionFromSentSignal(e,t){return t}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),_react=require("react"),_react2=_interopRequireDefault(_react),_reactDom=require("react-dom"),_reactDom2=_interopRequireDefault(_reactDom),_echarts=require("echarts"),_echarts2=_interopRequireDefault(_echarts),_lodash=require("lodash.merge"),_lodash2=_interopRequireDefault(_lodash),_insightWidgetApi=require("insight-widget-api"),_echarts3=require("../util/echarts/"),_echarts4=_interopRequireDefault(_echarts3),_formatter=require("../util/formatter"),EchartsHoc=function(e){function t(e,i){_classCallCheck(this,t);var r=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,i)),n=i.intl,a=i.settings,o=e.type;return r.state=_lodash2["default"](e,{yAxis:{axisLabel:{formatter:function(e){return n.formatNumber(e)}}},xAxis:{axisLabel:{formatter:function(e){return _formatter.axis(e,a.groupBy,n)}}},tooltip:{trigger:"item",formatter:function(e){var t=e.data,i=e.seriesIndex,r=e.percent,s=a.queries,u=s[i];return"pie"===o?_formatter.tooltip(t.value[1],u,n)+" ("+n.formatNumber(r/100,{style:"percent"})+")":_formatter.tooltip(t[1],u,n)}}}),r}return _inherits(t,e),_createClass(t,[{key:"componentDidMount",value:function(){var e=this.state,t=e.type,i=this.props,r=i.settings,n=i.aggregationResult,a=i.sendSignal,o=i.sentSignal,s=i.resetSignals,u=buildChartOptions(e,r,n,o);this.chartInstance=_echarts2["default"].init(this.chartContainer),"pie"===t?(this.chartInstance.on("pieselectchanged",function(e){var t=e.selected,i=Object.keys(t).find(function(e){return t[e]});i?a(_insightWidgetApi.buildFilterSignal(_insightWidgetApi.buildGroupByFilter(r.groupBy[0],i))):s()}),this.chartInstance.on("pieunselected",function(){return s()})):"map"===t?(this.chartInstance.on("mapselectchanged",function(e){var t=e.name,i=e.selected,n=Object.keys(i).find(function(e){return i[e]});n?a(_insightWidgetApi.buildFilterSignal(_insightWidgetApi.buildGroupByFilter(r.groupBy[0],t))):s()}),this.chartInstance.on("mapunselected",function(){return s()})):this.chartInstance.on("click",function(e){var t=e.componentType,i=e.name;if("series"===t&&i)if(Array.isArray(i))if(1===i.length)a(_insightWidgetApi.buildFilterSignal(_insightWidgetApi.buildGroupByFilter(r.groupBy[0],i[0])));else{var n={logic:"AND",filters:i.map(function(e,t){return _insightWidgetApi.buildGroupByFilter(r.groupBy[t],e)})};a(_insightWidgetApi.buildFilterSignal(n))}else a(_insightWidgetApi.buildFilterSignal(_insightWidgetApi.buildGroupByFilter(r.groupBy[0],i)))}),u&&this.chartInstance.setOption(u)}},{key:"componentDidUpdate",value:function(e){var t=this.state,i=this.props,r=i.settings,n=i.aggregationResult,a=i.height,o=i.width,s=i.sentSignal;if((a!==e.height||o!==e.width)&&this.chartInstance.resize(),e.settings!==r||e.aggregationResult!==n||s!==e.sentSignal){var u=buildChartOptions(t,r,n,s);u&&this.chartInstance.setOption(u)}}},{key:"componentWillUnmount",value:function(){this.chartInstance&&this.chartInstance.dispose()}},{key:"render",value:function(){var e=this;return _react2["default"].createElement("div",{style:{height:"100%"},className:"widget-stretch-height",ref:function(t){return e.chartContainer=_reactDom2["default"].findDOMNode(t)}})}}]),t}(_react2["default"].Component);EchartsHoc.propTypes={aggregationResult:_react2["default"].PropTypes.object.isRequired},exports["default"]=EchartsHoc;